import{e as V,f as Ne,g as U,r as l,a as F,V as R,j as r,I as ae,B as I,h as Ce,i as ie,R as z,k as K,S as ne,l as Ee,m as H,P as Y,c as Re,n as G,b as $,u as Pe,L as Me}from"./index-BrS_H_Qb.js";import{s as b}from"./socket-Cskg_VcQ.js";import{C as ce,b as le}from"./card-FV4SwpdD.js";/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const _e=V("Pause",[["rect",{width:"4",height:"16",x:"6",y:"4",key:"iffhe4"}],["rect",{width:"4",height:"16",x:"14",y:"4",key:"sjin7j"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ie=V("Play",[["polygon",{points:"5 3 19 12 5 21 5 3",key:"191637"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ae=V("SkipForward",[["polygon",{points:"5 4 15 12 5 20 5 4",key:"16p6eg"}],["line",{x1:"19",x2:"19",y1:"5",y2:"19",key:"futhcm"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Te=V("ThumbsDown",[["path",{d:"M17 14V2",key:"8ymqnk"}],["path",{d:"M9 18.12 10 14H4.17a2 2 0 0 1-1.92-2.56l2.33-8A2 2 0 0 1 6.5 2H20a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.76a2 2 0 0 0-1.79 1.11L12 22h0a3.13 3.13 0 0 1-3-3.88Z",key:"s6e0r"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const De=V("ThumbsUp",[["path",{d:"M7 10v12",key:"1qc93n"}],["path",{d:"M15 5.88 14 10h5.83a2 2 0 0 1 1.92 2.56l-2.33 8A2 2 0 0 1 17.5 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.76a2 2 0 0 0 1.79-1.11L12 2h0a3.13 3.13 0 0 1 3 3.88Z",key:"y3tblf"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Le=V("Trash2",[["path",{d:"M3 6h18",key:"d0wm0j"}],["path",{d:"M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6",key:"4alrt4"}],["path",{d:"M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2",key:"v07s0e"}],["line",{x1:"10",x2:"10",y1:"11",y2:"17",key:"1uufr5"}],["line",{x1:"14",x2:"14",y1:"11",y2:"17",key:"xtxkd"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ve=V("Volume2",[["polygon",{points:"11 5 6 9 2 9 2 15 6 15 11 19 11 5",key:"16drj5"}],["path",{d:"M15.54 8.46a5 5 0 0 1 0 7.07",key:"ltjumu"}],["path",{d:"M19.07 4.93a10 10 0 0 1 0 14.14",key:"1kegas"}]]);/**
 * @license lucide-react v0.330.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Be=V("VolumeX",[["polygon",{points:"11 5 6 9 2 9 2 15 6 15 11 19 11 5",key:"16drj5"}],["line",{x1:"22",x2:"16",y1:"9",y2:"15",key:"1ewh16"}],["line",{x1:"16",x2:"22",y1:"9",y2:"15",key:"5ykzw1"}]]),A=Ne(t=>({messages:[],queue:[],currentSong:null,setMessages:e=>t({messages:e}),addMessage:e=>t(o=>({messages:[...o.messages,e].slice(-50)})),setQueue:e=>t({queue:e}),setCurrentSong:e=>t({currentSong:e})})),ze=()=>{const{roomId:t}=U(),[e,o]=l.useState(""),s=A(n=>n.messages),d=A(n=>n.addMessage),i=F(n=>n.user),a=F(n=>n.isAuthenticated),m=l.useRef(null);l.useEffect(()=>(b.off("newMessage"),b.off("previousMessages"),b.off("error"),b.on("newMessage",n=>{d(n)}),b.on("previousMessages",n=>{A.getState().setMessages(n)}),b.on("error",({message:n})=>{R.error(n||"An error occurred")}),()=>{b.off("newMessage"),b.off("previousMessages"),b.off("error")}),[]),l.useEffect(()=>{m.current&&(m.current.scrollTop=m.current.scrollHeight)},[s]);const h=()=>{if(!e.trim())return;if(!a||!i){R.error("You must be logged in to send messages");return}if(!t){R.error("Invalid room");return}const n={roomId:t,userId:i._id,sender:i.username,message:e.trim()};o(""),b.emit("sendMessage",n,c=>{c!=null&&c.success||(R.error("Message failed to send. Please try again."),o(n.message))})};return r.jsxs("div",{className:"flex flex-col h-[calc(100vh-16rem)]",children:[r.jsx("div",{ref:m,className:"flex-1 overflow-y-auto p-4 space-y-4 min-h-0 flex flex-col",children:s.map((n,c)=>r.jsx("div",{className:`flex ${n.sender===(i==null?void 0:i.username)?"justify-end":"justify-start"}`,children:r.jsxs("div",{className:`max-w-[80%] rounded-lg p-3 ${n.sender===(i==null?void 0:i.username)?"bg-blue-500 text-white":"bg-gray-200"}`,children:[r.jsx("p",{className:"text-sm font-medium mb-1",children:n.sender}),r.jsx("p",{className:"text-sm break-words",children:n.message}),r.jsx("span",{className:"text-xs opacity-75 block mt-1",children:new Date(n.timestamp).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})})]})},n.timestamp||c))}),r.jsx("div",{className:"p-4 border-t bg-white mt-auto",children:r.jsxs("div",{className:"flex gap-2",children:[r.jsx(ae,{value:e,onChange:n=>o(n.target.value),placeholder:a?"Type a message...":"Please login to chat",onKeyPress:n=>n.key==="Enter"&&h(),disabled:!a,className:"flex-1"}),r.jsx(I,{onClick:h,disabled:!a,children:"Send"})]})})]})};function de(t,[e,o]){return Math.min(o,Math.max(e,t))}var Fe=l.createContext(void 0);function Ke(t){const e=l.useContext(Fe);return t||e||"ltr"}function qe(t){const e=l.useRef({value:t,previous:t});return l.useMemo(()=>(e.current.value!==t&&(e.current.previous=e.current.value,e.current.value=t),e.current.previous),[t])}function He(t){const[e,o]=l.useState(void 0);return Ce(()=>{if(t){o({width:t.offsetWidth,height:t.offsetHeight});const s=new ResizeObserver(d=>{if(!Array.isArray(d)||!d.length)return;const i=d[0];let a,m;if("borderBoxSize"in i){const h=i.borderBoxSize,n=Array.isArray(h)?h[0]:h;a=n.inlineSize,m=n.blockSize}else a=t.offsetWidth,m=t.offsetHeight;o({width:a,height:m})});return s.observe(t,{box:"border-box"}),()=>s.unobserve(t)}else o(void 0)},[t]),e}function Oe(t){const e=t+"CollectionProvider",[o,s]=ie(e),[d,i]=o(e,{collectionRef:{current:null},itemMap:new Map}),a=u=>{const{scope:S,children:x}=u,g=z.useRef(null),y=z.useRef(new Map).current;return r.jsx(d,{scope:S,itemMap:y,collectionRef:g,children:x})};a.displayName=e;const m=t+"CollectionSlot",h=z.forwardRef((u,S)=>{const{scope:x,children:g}=u,y=i(m,x),N=K(S,y.collectionRef);return r.jsx(ne,{ref:N,children:g})});h.displayName=m;const n=t+"CollectionItemSlot",c="data-radix-collection-item",f=z.forwardRef((u,S)=>{const{scope:x,children:g,...y}=u,N=z.useRef(null),j=K(S,N),k=i(n,x);return z.useEffect(()=>(k.itemMap.set(N,{ref:N,...y}),()=>void k.itemMap.delete(N))),r.jsx(ne,{[c]:"",ref:j,children:g})});f.displayName=n;function v(u){const S=i(t+"CollectionConsumer",u);return z.useCallback(()=>{const g=S.collectionRef.current;if(!g)return[];const y=Array.from(g.querySelectorAll(`[${c}]`));return Array.from(S.itemMap.values()).sort((k,P)=>y.indexOf(k.ref.current)-y.indexOf(P.ref.current))},[S.collectionRef,S.itemMap])}return[{Provider:a,Slot:h,ItemSlot:f},v,s]}var ue=["PageUp","PageDown"],me=["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"],fe={"from-left":["Home","PageDown","ArrowDown","ArrowLeft"],"from-right":["Home","PageDown","ArrowDown","ArrowRight"],"from-bottom":["Home","PageDown","ArrowDown","ArrowLeft"],"from-top":["Home","PageDown","ArrowUp","ArrowLeft"]},O="Slider",[ee,Ue,Qe]=Oe(O),[he,vt]=ie(O,[Qe]),[$e,W]=he(O),pe=l.forwardRef((t,e)=>{const{name:o,min:s=0,max:d=100,step:i=1,orientation:a="horizontal",disabled:m=!1,minStepsBetweenThumbs:h=0,defaultValue:n=[s],value:c,onValueChange:f=()=>{},onValueCommit:v=()=>{},inverted:u=!1,form:S,...x}=t,g=l.useRef(new Set),y=l.useRef(0),j=a==="horizontal"?Ye:We,[k=[],P]=Ee({prop:c,defaultProp:n,onChange:E=>{var L;(L=[...g.current][y.current])==null||L.focus(),f(E)}}),D=l.useRef(k);function q(E){const T=et(k,E);B(E,T)}function X(E){B(E,y.current)}function J(){const E=D.current[y.current];k[y.current]!==E&&v(k)}function B(E,T,{commit:L}={commit:!1}){const Q=ot(i),p=nt(Math.round((E-s)/i)*i+s,Q),w=de(p,[s,d]);P((C=[])=>{const M=Ge(C,w,T);if(st(M,h*i)){y.current=M.indexOf(w);const _=String(M)!==String(C);return _&&L&&v(M),_?M:C}else return C})}return r.jsx($e,{scope:t.__scopeSlider,name:o,disabled:m,min:s,max:d,valueIndexToChangeRef:y,thumbs:g.current,values:k,orientation:a,form:S,children:r.jsx(ee.Provider,{scope:t.__scopeSlider,children:r.jsx(ee.Slot,{scope:t.__scopeSlider,children:r.jsx(j,{"aria-disabled":m,"data-disabled":m?"":void 0,...x,ref:e,onPointerDown:H(x.onPointerDown,()=>{m||(D.current=k)}),min:s,max:d,inverted:u,onSlideStart:m?void 0:q,onSlideMove:m?void 0:X,onSlideEnd:m?void 0:J,onHomeKeyDown:()=>!m&&B(s,0,{commit:!0}),onEndKeyDown:()=>!m&&B(d,k.length-1,{commit:!0}),onStepKeyDown:({event:E,direction:T})=>{if(!m){const p=ue.includes(E.key)||E.shiftKey&&me.includes(E.key)?10:1,w=y.current,C=k[w],M=i*p*T;B(C+M,w,{commit:!0})}}})})})})});pe.displayName=O;var[xe,ge]=he(O,{startEdge:"left",endEdge:"right",size:"width",direction:1}),Ye=l.forwardRef((t,e)=>{const{min:o,max:s,dir:d,inverted:i,onSlideStart:a,onSlideMove:m,onSlideEnd:h,onStepKeyDown:n,...c}=t,[f,v]=l.useState(null),u=K(e,j=>v(j)),S=l.useRef(void 0),x=Ke(d),g=x==="ltr",y=g&&!i||!g&&i;function N(j){const k=S.current||f.getBoundingClientRect(),P=[0,k.width],q=oe(P,y?[o,s]:[s,o]);return S.current=k,q(j-k.left)}return r.jsx(xe,{scope:t.__scopeSlider,startEdge:y?"left":"right",endEdge:y?"right":"left",direction:y?1:-1,size:"width",children:r.jsx(ye,{dir:x,"data-orientation":"horizontal",...c,ref:u,style:{...c.style,"--radix-slider-thumb-transform":"translateX(-50%)"},onSlideStart:j=>{const k=N(j.clientX);a==null||a(k)},onSlideMove:j=>{const k=N(j.clientX);m==null||m(k)},onSlideEnd:()=>{S.current=void 0,h==null||h()},onStepKeyDown:j=>{const P=fe[y?"from-left":"from-right"].includes(j.key);n==null||n({event:j,direction:P?-1:1})}})})}),We=l.forwardRef((t,e)=>{const{min:o,max:s,inverted:d,onSlideStart:i,onSlideMove:a,onSlideEnd:m,onStepKeyDown:h,...n}=t,c=l.useRef(null),f=K(e,c),v=l.useRef(void 0),u=!d;function S(x){const g=v.current||c.current.getBoundingClientRect(),y=[0,g.height],j=oe(y,u?[s,o]:[o,s]);return v.current=g,j(x-g.top)}return r.jsx(xe,{scope:t.__scopeSlider,startEdge:u?"bottom":"top",endEdge:u?"top":"bottom",size:"height",direction:u?1:-1,children:r.jsx(ye,{"data-orientation":"vertical",...n,ref:f,style:{...n.style,"--radix-slider-thumb-transform":"translateY(50%)"},onSlideStart:x=>{const g=S(x.clientY);i==null||i(g)},onSlideMove:x=>{const g=S(x.clientY);a==null||a(g)},onSlideEnd:()=>{v.current=void 0,m==null||m()},onStepKeyDown:x=>{const y=fe[u?"from-bottom":"from-top"].includes(x.key);h==null||h({event:x,direction:y?-1:1})}})})}),ye=l.forwardRef((t,e)=>{const{__scopeSlider:o,onSlideStart:s,onSlideMove:d,onSlideEnd:i,onHomeKeyDown:a,onEndKeyDown:m,onStepKeyDown:h,...n}=t,c=W(O,o);return r.jsx(Y.span,{...n,ref:e,onKeyDown:H(t.onKeyDown,f=>{f.key==="Home"?(a(f),f.preventDefault()):f.key==="End"?(m(f),f.preventDefault()):ue.concat(me).includes(f.key)&&(h(f),f.preventDefault())}),onPointerDown:H(t.onPointerDown,f=>{const v=f.target;v.setPointerCapture(f.pointerId),f.preventDefault(),c.thumbs.has(v)?v.focus():s(f)}),onPointerMove:H(t.onPointerMove,f=>{f.target.hasPointerCapture(f.pointerId)&&d(f)}),onPointerUp:H(t.onPointerUp,f=>{const v=f.target;v.hasPointerCapture(f.pointerId)&&(v.releasePointerCapture(f.pointerId),i(f))})})}),ve="SliderTrack",Se=l.forwardRef((t,e)=>{const{__scopeSlider:o,...s}=t,d=W(ve,o);return r.jsx(Y.span,{"data-disabled":d.disabled?"":void 0,"data-orientation":d.orientation,...s,ref:e})});Se.displayName=ve;var te="SliderRange",be=l.forwardRef((t,e)=>{const{__scopeSlider:o,...s}=t,d=W(te,o),i=ge(te,o),a=l.useRef(null),m=K(e,a),h=d.values.length,n=d.values.map(v=>je(v,d.min,d.max)),c=h>1?Math.min(...n):0,f=100-Math.max(...n);return r.jsx(Y.span,{"data-orientation":d.orientation,"data-disabled":d.disabled?"":void 0,...s,ref:m,style:{...t.style,[i.startEdge]:c+"%",[i.endEdge]:f+"%"}})});be.displayName=te;var re="SliderThumb",we=l.forwardRef((t,e)=>{const o=Ue(t.__scopeSlider),[s,d]=l.useState(null),i=K(e,m=>d(m)),a=l.useMemo(()=>s?o().findIndex(m=>m.ref.current===s):-1,[o,s]);return r.jsx(Xe,{...t,ref:i,index:a})}),Xe=l.forwardRef((t,e)=>{const{__scopeSlider:o,index:s,name:d,...i}=t,a=W(re,o),m=ge(re,o),[h,n]=l.useState(null),c=K(e,N=>n(N)),f=h?a.form||!!h.closest("form"):!0,v=He(h),u=a.values[s],S=u===void 0?0:je(u,a.min,a.max),x=Ze(s,a.values.length),g=v==null?void 0:v[m.size],y=g?tt(g,S,m.direction):0;return l.useEffect(()=>{if(h)return a.thumbs.add(h),()=>{a.thumbs.delete(h)}},[h,a.thumbs]),r.jsxs("span",{style:{transform:"var(--radix-slider-thumb-transform)",position:"absolute",[m.startEdge]:`calc(${S}% + ${y}px)`},children:[r.jsx(ee.ItemSlot,{scope:t.__scopeSlider,children:r.jsx(Y.span,{role:"slider","aria-label":t["aria-label"]||x,"aria-valuemin":a.min,"aria-valuenow":u,"aria-valuemax":a.max,"aria-orientation":a.orientation,"data-orientation":a.orientation,"data-disabled":a.disabled?"":void 0,tabIndex:a.disabled?void 0:0,...i,ref:c,style:u===void 0?{display:"none"}:t.style,onFocus:H(t.onFocus,()=>{a.valueIndexToChangeRef.current=s})})}),f&&r.jsx(Je,{name:d??(a.name?a.name+(a.values.length>1?"[]":""):void 0),form:a.form,value:u},s)]})});we.displayName=re;var Je=t=>{const{value:e,...o}=t,s=l.useRef(null),d=qe(e);return l.useEffect(()=>{const i=s.current,a=window.HTMLInputElement.prototype,h=Object.getOwnPropertyDescriptor(a,"value").set;if(d!==e&&h){const n=new Event("input",{bubbles:!0});h.call(i,e),i.dispatchEvent(n)}},[d,e]),r.jsx("input",{style:{display:"none"},...o,ref:s,defaultValue:e})};function Ge(t=[],e,o){const s=[...t];return s[o]=e,s.sort((d,i)=>d-i)}function je(t,e,o){const i=100/(o-e)*(t-e);return de(i,[0,100])}function Ze(t,e){return e>2?`Value ${t+1} of ${e}`:e===2?["Minimum","Maximum"][t]:void 0}function et(t,e){if(t.length===1)return 0;const o=t.map(d=>Math.abs(d-e)),s=Math.min(...o);return o.indexOf(s)}function tt(t,e,o){const s=t/2,i=oe([0,50],[0,s]);return(s-i(e)*o)*o}function rt(t){return t.slice(0,-1).map((e,o)=>t[o+1]-e)}function st(t,e){if(e>0){const o=rt(t);return Math.min(...o)>=e}return!0}function oe(t,e){return o=>{if(t[0]===t[1]||e[0]===e[1])return e[0];const s=(e[1]-e[0])/(t[1]-t[0]);return e[0]+s*(o-t[0])}}function ot(t){return(String(t).split(".")[1]||"").length}function nt(t,e){const o=Math.pow(10,e);return Math.round(t*o)/o}var ke=pe,at=Se,it=be,ct=we;const se=l.forwardRef(({className:t,...e},o)=>r.jsxs(ke,{ref:o,className:Re("relative flex w-full touch-none select-none items-center",t),...e,children:[r.jsx(at,{className:"relative h-2 w-full grow overflow-hidden rounded-full bg-secondary",children:r.jsx(it,{className:"absolute h-full bg-primary"})}),r.jsx(ct,{className:"block h-5 w-5 rounded-full border-2 border-primary bg-background ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50"})]}));se.displayName=ke.displayName;const lt=()=>{const{roomId:t}=U(),e=l.useRef(null),[o,s]=l.useState(!1),[d,i]=l.useState(0),[a,m]=l.useState(0),[h,n]=l.useState(1),[c,f]=l.useState(!1),v=l.useRef(1),[u,S]=l.useState(!1),x=A(p=>p.currentSong),g=A(p=>p.setCurrentSong),y=F(p=>p.user),N=l.useRef(Date.now()),j=A(p=>p.queue),[k,P]=l.useState(!1),D=l.useRef(!1),q=l.useRef(!0);l.useEffect(()=>{(async()=>{try{if(!t||!(y!=null&&y._id))return;const w=await $.get(`/rooms/${t}`),C=w.data.creator._id||w.data.creator;S(C.toString()===y._id.toString())}catch(w){console.error("Failed to check room creator status:",w)}})()},[t,y==null?void 0:y._id]),l.useEffect(()=>{const p=()=>{D.current=!0,document.removeEventListener("click",p),document.removeEventListener("keydown",p)};return document.addEventListener("click",p),document.addEventListener("keydown",p),()=>{document.removeEventListener("click",p),document.removeEventListener("keydown",p)}},[]),l.useEffect(()=>{if(x&&e.current){e.current.src=x.url,e.current.load(),e.current.volume=h;const p=async()=>{var w,C;try{o&&(D.current||u?await((w=e.current)==null?void 0:w.play()):q.current&&(G.success("Click anywhere to enable audio playback",{duration:5e3}),q.current=!1))}catch(M){console.error("Playback failed:",M),s(!1),u&&b.emit("updatePlaybackState",{roomId:t,currentTime:((C=e.current)==null?void 0:C.currentTime)||0,isPlaying:!1,currentSong:x})}};return e.current.addEventListener("canplay",p),()=>{e.current&&e.current.removeEventListener("canplay",p)}}},[x,o,h,u,t]),l.useEffect(()=>{if(t){b.emit("requestPlaybackState",{roomId:t});const p=async({currentTime:w,isPlaying:C,currentSong:M})=>{if(e.current){if(M&&(!x||M._id!==x._id)){if(g(M),e.current.src=M.url,e.current.load(),e.current.currentTime=w,i(w),C)try{const _=e.current.play();_!==void 0&&_.catch(()=>{P(!0)})}catch(_){console.error("Playback failed:",_),P(!0)}}else if(e.current.currentTime=w,i(w),C!==o)if(C)try{const _=e.current.play();_!==void 0&&_.catch(()=>{P(!0)})}catch(_){console.error("Playback failed:",_),P(!0)}else e.current.pause();s(C)}};return b.on("playbackStateUpdate",p),b.on("roomState",p),b.on("songAdded",()=>{b.emit("requestPlaybackState",{roomId:t})}),()=>{b.off("playbackStateUpdate"),b.off("roomState"),b.off("songAdded")}}},[t,x,o]),l.useEffect(()=>{const p=()=>{if(D.current=!0,k&&e.current&&o){const w=e.current.play();w!==void 0&&w.then(()=>{P(!1)}).catch(C=>{console.error("Failed to resume playback:",C)})}};return window.addEventListener("click",p,{once:!0}),window.addEventListener("touchstart",p,{once:!0}),window.addEventListener("keydown",p,{once:!0}),()=>{window.removeEventListener("click",p),window.removeEventListener("touchstart",p),window.removeEventListener("keydown",p)}},[k,o]),l.useEffect(()=>{if(x&&e.current&&(e.current.src=x.url,e.current.load(),e.current.volume=h,o)){const p=e.current.play();p!==void 0&&p.catch(()=>{P(!0)})}},[x,h]),l.useEffect(()=>{!x&&j.length>0&&g(j[0])},[j,x,g]),l.useEffect(()=>{e.current&&(e.current.volume=h)},[h]);const X=()=>{if(e.current){const p=e.current.currentTime;i(p),m(e.current.duration),u&&Math.abs(p-N.current)>.5&&(N.current=p,b.emit("updatePlaybackTime",{roomId:t,time:p}))}},J=()=>{x&&b.emit("songEnded",{roomId:t,songId:x._id,queue:j})},B=p=>{!u||!e.current||(e.current.currentTime=p,b.emit("seekTime",{roomId:t,time:p}))},E=async()=>{if(u)try{e.current&&(o?(e.current.pause(),s(!1)):(await e.current.play(),s(!0)),b.emit("updatePlaybackState",{roomId:t,currentTime:e.current.currentTime,isPlaying:!o,currentSong:x,duration:e.current.duration}))}catch(p){console.error("Error handling play/pause:",p),G.error("Failed to play audio. Please try again.")}},T=()=>{u&&b.emit("skipSong",{roomId:t})},L=([p])=>{const w=p/100;n(w),e.current&&(e.current.volume=w),w>0&&f(!1)},Q=()=>{e.current&&(c?(e.current.volume=v.current,n(v.current)):(v.current=h,e.current.volume=0,n(0)),f(!c))};return l.useEffect(()=>(b.on("nextSong",({song:p,isPlaying:w})=>{p&&(g(p),s(w),i(0),e.current&&(e.current.currentTime=0,w&&(D.current||u)&&e.current.play().catch(()=>{P(!0)})))}),()=>{b.off("nextSong")}),[g,u]),r.jsxs("div",{className:"w-full space-y-4",children:[r.jsx("audio",{ref:e,src:x==null?void 0:x.url,onTimeUpdate:X,onEnded:J,onError:p=>{console.error("Audio error:",p),G.error("Playback error occurred"),s(!1)},preload:"auto"}),x?r.jsxs(r.Fragment,{children:[r.jsxs("div",{className:"flex justify-between items-center",children:[r.jsxs("div",{children:[r.jsx("h3",{className:"font-semibold",children:x.title}),r.jsx("p",{className:"text-sm text-gray-500",children:x.artist})]}),r.jsxs("div",{className:"flex items-center gap-2",children:[u&&r.jsxs(r.Fragment,{children:[r.jsx(I,{variant:"ghost",size:"icon",onClick:E,children:o?r.jsx(_e,{className:"h-6 w-6"}):r.jsx(Ie,{className:"h-6 w-6"})}),r.jsx(I,{variant:"ghost",size:"icon",onClick:T,children:r.jsx(Ae,{className:"h-6 w-6"})})]}),r.jsxs("div",{className:"flex items-center gap-2 ml-4",style:{width:"150px"},children:[r.jsx(I,{variant:"ghost",size:"icon",onClick:Q,children:c||h===0?r.jsx(Be,{className:"h-4 w-4"}):r.jsx(Ve,{className:"h-4 w-4"})}),r.jsx(se,{value:[h*100],max:100,step:1,onValueChange:L,className:"w-24"})]})]})]}),r.jsx(se,{value:[d],max:a,step:1,onValueChange:([p])=>B(p),disabled:!u,className:"mt-2"})]}):r.jsxs("div",{className:"text-center py-8",children:[r.jsx("p",{className:"text-gray-500",children:"No songs in queue"}),r.jsx("p",{className:"text-sm text-gray-400",children:"Add songs to start playing"})]})]})},dt=()=>{const{roomId:t}=U(),e=A(n=>n.queue),o=A(n=>n.currentSong),s=F(n=>n.user),[d,i]=l.useState(!1);l.useEffect(()=>{(async()=>{try{if(!t||!(s!=null&&s._id))return;const c=await $.get(`/rooms/${t}`),f=c.data.creator._id||c.data.creator;i(f.toString()===s._id.toString())}catch(c){console.error("Failed to check room creator status:",c)}})()},[t,s==null?void 0:s._id]);const a=e.filter(n=>n._id!==(o==null?void 0:o._id)),m=async(n,c)=>{try{if(!(s!=null&&s._id)){R.error("Must be logged in to vote");return}b.emit("voteSong",{roomId:t,songId:n,voteType:c,userId:s._id})}catch{R.error("Failed to vote")}},h=async n=>{try{if(!(s!=null&&s._id)){R.error("Must be logged in to delete songs");return}b.emit("deleteSong",{roomId:t,songId:n,userId:s._id})}catch{R.error("Failed to delete song")}};return a.length===0?r.jsx("div",{className:"text-center p-4 text-gray-500",children:"No songs in queue"}):r.jsx("div",{className:"space-y-4",children:a.map(n=>{var c,f,v,u;return r.jsx(ce,{children:r.jsxs(le,{className:"flex items-center justify-between p-4",children:[r.jsxs("div",{children:[r.jsx("h3",{className:"font-semibold",children:n.title}),r.jsx("p",{className:"text-sm text-gray-500",children:n.artist})]}),r.jsxs("div",{className:"flex items-center gap-2",children:[r.jsxs("div",{className:"flex items-center gap-1",children:[r.jsxs("span",{className:"text-sm text-green-500",children:["+",n.upvotes]}),r.jsx(I,{variant:"ghost",size:"sm",onClick:()=>m(n._id,"upvote"),className:(c=n.upvoters)!=null&&c.includes((s==null?void 0:s._id)??"")?"bg-green-100":"",children:r.jsx(De,{className:`h-4 w-4 ${(f=n.upvoters)!=null&&f.includes((s==null?void 0:s._id)??"")?"text-green-500":""}`})})]}),r.jsxs("div",{className:"flex items-center gap-1",children:[r.jsxs("span",{className:"text-sm text-red-500",children:["+",n.downvotes]}),r.jsx(I,{variant:"ghost",size:"sm",onClick:()=>m(n._id,"downvote"),className:(v=n.downvoters)!=null&&v.includes((s==null?void 0:s._id)??"")?"bg-red-100":"",children:r.jsx(Te,{className:`h-4 w-4 ${(u=n.downvoters)!=null&&u.includes((s==null?void 0:s._id)??"")?"text-red-500":""}`})})]}),r.jsxs("span",{className:"text-sm text-gray-500 ml-2",children:["Total: ",n.votes]}),((s==null?void 0:s._id)===n.addedBy||d)&&r.jsx(I,{variant:"ghost",size:"sm",onClick:()=>h(n._id),className:"text-red-500 hover:text-red-700",children:r.jsx(Le,{className:"h-4 w-4"})})]})]})},n._id)})})},ut=({})=>{const{roomId:t}=U(),[e,o]=l.useState(""),[s,d]=l.useState([]),[i,a]=l.useState(!1),m=F(c=>c.user),h=async()=>{if(!e.trim()){R.error("Please enter a search term");return}a(!0);try{const c=await fetch(`https://saavn.dev/api/search/songs?query=${encodeURIComponent(e)}`);if(!c.ok)throw new Error("Failed to fetch from Saavn API");const f=await c.json();if(!f.success||!f.data.results)throw new Error("No results found");d(f.data.results)}catch(c){console.error("Saavn search error:",c),R.error("Failed to search songs"),d([])}finally{a(!1)}},n=async c=>{var f,v,u;if(!t||!(m!=null&&m._id)){R.error("Must be logged in to add songs");return}try{const S=(f=c.downloadUrl.sort((g,y)=>{const N=parseInt(g.quality.replace("kbps",""));return parseInt(y.quality.replace("kbps",""))-N})[0])==null?void 0:f.url;if(!S)throw new Error("No download URL available");const x={title:c.name,artist:c.artists.primary.map(g=>g.name).join(", "),url:S,addedBy:m._id,thumbnail:((v=c.image.find(g=>g.quality==="500x500"))==null?void 0:v.url)||((u=c.image[0])==null?void 0:u.url),duration:c.duration,albumName:c.album.name,id:c.id};b.emit("addSong",{roomId:t,song:x,userId:m._id}),o(""),d([]),R.success("Song added to queue")}catch(S){console.error("Add to queue error:",S),R.error("Failed to add song to queue")}};return r.jsxs("div",{className:"space-y-4",children:[r.jsxs("div",{className:"flex gap-2",children:[r.jsx(ae,{value:e,onChange:c=>o(c.target.value),placeholder:"Search for songs...",onKeyPress:c=>c.key==="Enter"&&h(),disabled:i}),r.jsx(I,{onClick:h,disabled:i,children:i?"Searching...":"Search"})]}),r.jsx("div",{className:"grid gap-4",children:s.map(c=>{var f,v;return r.jsx(ce,{children:r.jsxs(le,{className:"flex items-center gap-4 p-4",children:[r.jsx("img",{src:((f=c.image.find(u=>u.quality==="500x500"))==null?void 0:f.url)||((v=c.image[0])==null?void 0:v.url),alt:c.name,className:"w-20 h-20 object-cover rounded"}),r.jsxs("div",{className:"flex-1",children:[r.jsx("h3",{className:"font-semibold",children:c.name}),r.jsx("p",{className:"text-sm text-gray-500",children:c.artists.primary.map(u=>u.name).join(", ")}),c.album.name&&r.jsxs("p",{className:"text-xs text-gray-400",children:["Album: ",c.album.name]})]}),r.jsx(I,{onClick:()=>n(c),children:"Add to Queue"})]})},c.id)})})]})},mt=l.createContext(null),Z={didCatch:!1,error:null};class ft extends l.Component{constructor(e){super(e),this.resetErrorBoundary=this.resetErrorBoundary.bind(this),this.state=Z}static getDerivedStateFromError(e){return{didCatch:!0,error:e}}resetErrorBoundary(){const{error:e}=this.state;if(e!==null){for(var o,s,d=arguments.length,i=new Array(d),a=0;a<d;a++)i[a]=arguments[a];(o=(s=this.props).onReset)===null||o===void 0||o.call(s,{args:i,reason:"imperative-api"}),this.setState(Z)}}componentDidCatch(e,o){var s,d;(s=(d=this.props).onError)===null||s===void 0||s.call(d,e,o)}componentDidUpdate(e,o){const{didCatch:s}=this.state,{resetKeys:d}=this.props;if(s&&o.error!==null&&ht(e.resetKeys,d)){var i,a;(i=(a=this.props).onReset)===null||i===void 0||i.call(a,{next:d,prev:e.resetKeys,reason:"keys"}),this.setState(Z)}}render(){const{children:e,fallbackRender:o,FallbackComponent:s,fallback:d}=this.props,{didCatch:i,error:a}=this.state;let m=e;if(i){const h={error:a,resetErrorBoundary:this.resetErrorBoundary};if(typeof o=="function")m=o(h);else if(s)m=l.createElement(s,h);else if(d!==void 0)m=d;else throw a}return l.createElement(mt.Provider,{value:{didCatch:i,error:a,resetErrorBoundary:this.resetErrorBoundary}},m)}}function ht(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:[],e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:[];return t.length!==e.length||t.some((o,s)=>!Object.is(o,e[s]))}const pt=({error:t,resetErrorBoundary:e})=>r.jsxs("div",{className:"p-4 text-red-500",children:[r.jsx("h2",{children:"Something went wrong:"}),r.jsx("pre",{children:t.message}),r.jsx(I,{onClick:e,children:"Try again"})]}),St=()=>{const{roomId:t}=U(),e=Pe(),o=F(u=>u.user),s=F(u=>u.isAuthenticated),d=A(u=>u.setQueue),[i,a]=l.useState(!0),[m,h]=l.useState(!1),[n,c]=l.useState(!1);l.useEffect(()=>{if(!s||!t){const S=`/room/${t}`;e(`/login?from=${encodeURIComponent(S)}`);return}return(async()=>{try{a(!0);const S=await $.get(`/rooms/${t}`),x=S.data.creator._id||S.data.creator,g=o==null?void 0:o._id,y=x.toString()===(g==null?void 0:g.toString());console.log("Room creator check:",{creatorId:x,userId:g,isCreator:y}),c(y);const N=S.data.participants.some(j=>j.toString()===(g==null?void 0:g.toString()));!y&&!N?h(!0):await f()}catch(S){console.error("Failed to check room:",S),R.error("Failed to load room"),e("/")}finally{a(!1)}})(),()=>{b.off("roomState"),b.off("previousMessages"),b.off("newMessage"),b.off("updateQueue")}},[s,t,o==null?void 0:o._id]);const f=async()=>{try{a(!0),b.emit("joinRoom",{roomId:t,userId:o==null?void 0:o._id}),b.on("roomInitialState",({messages:u,queue:S,isCreator:x})=>{A.getState().setMessages(u||[]),A.getState().setQueue(S||[]),c(x)}),b.on("updateQueue",u=>{d(u||[])}),await new Promise(u=>setTimeout(u,500))}catch(u){console.error("Error initializing room:",u),R.error("Failed to initialize room")}finally{a(!1)}},v=async()=>{try{a(!0),await $.post(`/rooms/join/${t}`),h(!1),await f()}catch(u){console.error("Failed to join room:",u),R.error("Failed to join room"),e("/")}finally{a(!1)}};return i?r.jsx(Me,{}):m?r.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50",children:r.jsxs("div",{className:"bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full mx-4",children:[r.jsx("h2",{className:"text-xl font-bold mb-4",children:"Join Room?"}),r.jsx("p",{className:"mb-6",children:"Would you like to join this music room?"}),r.jsxs("div",{className:"flex gap-4 justify-end",children:[r.jsx(I,{variant:"outline",onClick:()=>e("/"),children:"No, thanks"}),r.jsx(I,{onClick:v,children:"Yes, join room"})]})]})}):r.jsx(ft,{FallbackComponent:pt,children:r.jsx("div",{className:" relative w-full",children:r.jsxs("div",{className:"  px-4 sm:px-6 lg:px-8 py-10",children:[r.jsx("div",{className:"py-4 text-center",children:r.jsx("h1",{className:"text-3xl md:text-4xl font-extrabold text-purple-700 mb-2 tracking-tight drop-shadow-lg",children:"Music Room"})}),r.jsxs("div",{className:"grid grid-cols-12 gap-8",children:[r.jsxs("div",{className:"col-span-12 lg:col-span-8 space-y-8",children:[r.jsx("div",{className:"bg-white/90 rounded-2xl shadow-xl p-6",children:r.jsx(lt,{})}),r.jsxs("div",{className:"bg-white/90 rounded-2xl shadow-xl p-6",children:[r.jsx("h2",{className:"text-xl font-bold text-purple-700 mb-4",children:"Queue"}),r.jsx(dt,{})]}),r.jsxs("div",{className:"bg-white/90 rounded-2xl shadow-xl p-6",children:[r.jsx("h2",{className:"text-xl font-bold text-purple-700 mb-4",children:"Add Songs"}),r.jsx(ut,{isRoomCreator:n})]})]}),r.jsx("div",{className:"col-span-12 lg:col-span-4",children:r.jsxs("div",{className:"bg-white/90 rounded-2xl shadow-xl h-full flex flex-col",children:[r.jsx("div",{className:"p-6 border-b border-purple-100",children:r.jsx("h2",{className:"text-xl font-bold text-purple-700",children:"Chat"})}),r.jsx("div",{className:"flex-1 overflow-y-auto",children:r.jsx(ze,{})})]})})]})]})})})};export{St as default};
